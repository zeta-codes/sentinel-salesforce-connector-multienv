id: b8f2c9d1-3e4a-5b67-8901-234567890abc
version: 1.0.0
name: Salesforce Impossible Travel Logins
description: |
  Detects impossible travel: successful Salesforce logins for the same user from 2+ different countries within a 30-minute window. Uses public GeoIP database for IP geolocation. Includes countries list and user details in alerts.
requiredDataConnectors:
  - connectorId: SalesforceServiceCloudV2
    dataTypes:
      - SalesforceServiceCloudV2_CL
tactics:
  - InitialAccess
relevantTechniques:
  - T1078.004
query: |
  let threshold = 2;  // Minimum countries for alert (impossible travel detection)
  let Countrydb = externaldata(Network:string, geoname_id:string, continent_code:string, continent_name:string, country_iso_code:string, country_name:string)
  [@\"https://raw.githubusercontent.com/datasets/geoip2-ipv4/master/data/geoip2-ipv4.csv\"];  // Load public GeoIP database for IPâ†’country mapping
  let UsersLocation = SalesforceServiceCloudV2_CL
  | where EventType =~ 'Login' and tostring(JsonData.LOGIN_STATUS) == 'LOGIN_NO_ERROR'  // Successful logins only
  | project TimeGenerated, TimestampDerived, ClientIp = tostring(JsonData.CLIENT_IP), UserId, UserName = tostring(UserName), UserType = tostring(JsonData.USER_TYPE);
  UsersLocation
  | extend Dummy=1
  | summarize count() by Hour=bin(TimestampDerived, 30m), ClientIp, UserName, UserId, Dummy  // Aggregate logins per 30m window per IP/user
  | partition by Hour(  // Per time window: geolocate each IP
    lookup (Countrydb | extend Dummy=1) on Dummy
    | where ipv4_is_match(ClientIp, Network)
  )
  | summarize NumOfCountries = dcount(country_name), Countries = make_set(country_name, 10) by UserName, UserId, Hour  // Count/set distinct countries per user per hour
  | where NumOfCountries >= threshold  // Flag impossible travel (2+ countries)
  | project UserName, UserId, Hour, NumOfCountries, Countries
severity: High
requiredPermissions:
  - read
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: FullName
        columnName: UserName
      - identifier: ObjectId
        columnName: UserId
triggerThreshold: 0
queryFrequency: 1h
queryPeriod: 1h
alertDetailsOverride:
  alertDisplayNameFormat: Impossible Travel {{UserName}} ({{NumOfCountries}} countries)
tags:
  - Salesforce
  - ImpossibleTravel
  - GeoLocation
