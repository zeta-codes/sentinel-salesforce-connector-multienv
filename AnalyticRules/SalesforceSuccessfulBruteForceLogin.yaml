id: 85af2b7a-eabf-4d0e-be7d-835370bc19e9
version: 1.0.0
name: Salesforce Successful Brute Force Login
description: |
  Identifies successful brute force login attacks on Salesforce accounts by detecting multiple failed login attempts (threshold: 10+) within 1 hour, immediately followed by a successful login from the same UserId. Alerts include attacker IPs, attempt counts, and time window.
requiredDataConnectors:
  - connectorId: SalesforceServiceCloudV2
    dataTypes:
      - SalesforceServiceCloudV2_CL
tactics:
  - CredentialAccess
relevantTechniques:
  - T1110
query: |
  // Detects successful brute force attacks: multiple failures followed by success on same UserId
  let failureCountThreshold = 10;  // Threshold for failures (tune based on your environment)
  let successCountThreshold = 1;   // Minimum successes to confirm compromise
  // Step 1: Extract FAILED login attempts (non-success status)
  let Failures =
  SalesforceServiceCloudV2_CL
  | where EventType =~ "Login" 
  | where tostring(JsonData.LOGIN_STATUS) != "LOGIN_NO_ERROR"  // Salesforce failure code
  | summarize 
      FailureStartTime = min(TimestampDerived),     // Earliest failure
      FailureEndTime = max(TimestampDerived),       // Latest failure  
      IpAddresses = make_set_if(tostring(JsonData.CLIENT_IP), isnotempty(JsonData.CLIENT_IP), 100),  // Unique attacker IPs (max 100)
      FailureCount = count()                        // Total failures in window
      by UserName, UserId, tostring(JsonData.USER_TYPE);  // Group by user + type (Standard/Guest/etc)
  // Step 2: Extract SUCCESSFUL logins (exact success code)
  let Successes =
  SalesforceServiceCloudV2_CL
  | where EventType =~ "Login"
  | where tostring(JsonData.LOGIN_STATUS) == "LOGIN_NO_ERROR"  // Exact success
  | summarize 
      SuccessStartTime = min(TimestampDerived),    // Earliest success
      SuccessEndTime = max(TimestampDerived),      // Latest success
      SuccessCount = count()                       // Total successes
      by UserName, UserId, UserType = tostring(JsonData.USER_TYPE), EnvironmentName;
  // Step 3: Correlate - failures MUST precede success
  Failures
  | join kind=leftouter (
      Successes
  ) on UserId  // Match on UserId
  | where FailureCount >= failureCountThreshold    // Enough failures?
  | where SuccessCount >= successCountThreshold    // At least 1 success?
  | where FailureEndTime < SuccessStartTime        // CRITICAL: Failures happened BEFORE success
  | extend 
      AttackWindow = datetime_diff('minute', SuccessStartTime, FailureStartTime),  // Time from first fail to success
      TotalAttempts = FailureCount + SuccessCount  // Total login attempts
  | project 
      UserName, 
      UserId,
      UserType,
      EventStartTime = FailureStartTime,   // Attack began
      EventEndTime = SuccessEndTime,       // Attack succeeded  
      FailureCount,
      SuccessCount,
      AttackerIPs = IpAddresses,
      AttackWindow,
      EnvironmentName
severity: High
requiredPermissions:
  - read
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: FullName
        columnName: UserName
      - identifier: ObjectId
        columnName: UserId
triggerThreshold: 0
queryFrequency: 15m
queryPeriod: 1h
alertDetailsOverride:
  alertDisplayNameFormat: Salesforce Brute Force on {{UserName}}
tags:
  - Salesforce
  - BruteForce
