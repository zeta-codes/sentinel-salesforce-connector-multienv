id: 92c3d4e5-f6a7-8b9c-0d1e-2f3a4b5c6d7e
version: 1.0.0
name: Salesforce Password Spray Multi-User
description: |
  Detects password spraying brute force attacks where a single IP targets multiple (>15) unique Salesforce users with failed logins within 5-minute windows. Alerts include attacker IP, targeted user list, and failure count.
requiredDataConnectors:
  - connectorId: SalesforceServiceCloudV2
    dataTypes:
      - SalesforceServiceCloudV2_CL
tactics:
  - CredentialAccess
relevantTechniques:
  - T1110.001
query: |
  // Detects password spraying: single IP attacks multiple users in 5min window
  let FailureThreshold = 15;  // Minimum unique users targeted from one IP to trigger alert
  SalesforceServiceCloudV2_CL
  | where EventType =~ 'Login'  // Filter to login events only
  | where tostring(JsonData.LOGIN_STATUS) in~ ('LOGIN_ERROR_INVALID_PASSWORD', 'LOGIN_ERROR_SSO_PWD_INVALID')  // Specific failed login error types (password/SSO)
  | summarize UserCount=dcount(UserId), Users=make_set(UserId,100) by AttackerIP = tostring(JsonData.CLIENT_IP), bin(TimestampDerived, 5m)  // Count distinct users per IP in 5min windows, collect up to 100 UserIds
  | where UserCount > FailureThreshold  // Flag IPs targeting 15+ unique accounts (password spraying)
  | project TimestampDerived, AttackerIP, UserCount, Users  // Output for alert: time bin, IP, user count, targeted accounts
severity: High
requiredPermissions:
  - read
entityMappings:
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: AttackerIP
triggerThreshold: 0
queryFrequency: 5m
queryPeriod: 30m
alertDetailsOverride:
  alertDisplayNameFormat: Salesforce Password Spray from {{AttackerIP}}
tags:
  - Salesforce
  - BruteForce
  - PasswordSpray
